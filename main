#GUI Tutorial used: https://www.blog.pythonlibrary.org/2021/09/29/create-gui/



import wx
import wx.adv
from datetime import datetime



import filehandling
import visualization



global savefile 
savefile ='visualizationtesting.csv'



def getmonthentries(month):
    pastentries=filehandling.getpastentries(savefile)
    pastentries = [row for row in pastentries if row[1]==month]
    return([row[2] for row in pastentries])


# class Mycalendardateattr(wx.adv.CalendarDateAttr):

#     def __init__ (self):
#         super().__init__(colBack='green')
#         print(self.GetBackgroundColour())


class MyPanel(wx.Panel):
    dateselector=None
    markstyle=None
    # markstyle = Mycalendardateattr()


    def markdays(self, dateselector, markstyle):
            monthentrylist=getmonthentries(self.month)  
            for i in range(30):
                if not dateselector.GetAttr(i+1) == None:
                    dateselector.ResetAttr(i+1)

            for daytomark in monthentrylist:
                if dateselector.GetAttr(daytomark) == None:
                    dateselector.SetAttr(daytomark,markstyle)
                

    
    
    def __init__(self, parent):
        super().__init__(parent)
        
        now = datetime.now()
        self.year = int(now.strftime("%Y")) #default
        self.month = int(now.strftime("%m")) #default
        self.day = int(now.strftime("%d")) #default
        self.firstday=False
        self.blood = 0
        self.pain = 0
        self.painkiller = False
        self.forgotcheck=False

        
        self.dateselector=wx.adv.GenericCalendarCtrl(self, name="datectrl")
        self.dateselector.EnableHolidayDisplay(False)
        self.dateselector.Bind(wx.adv.EVT_CALENDAR_SEL_CHANGED,self.on_selectionchanged)
        self.markstyle=wx.adv.CalendarDateAttr(colBack='green')
        self.markdays(self.dateselector, self.markstyle)
        self.dateselector.Bind(wx.adv.EVT_CALENDAR_PAGE_CHANGED,self.on_pagechanged)

        forgotcheck=wx.CheckBox(self, label="FORGOTTEN? - first entry since longer, forgot to enter last bleeding/pain? (all days from last entry will be marked forgotten)",
            name='forgot_check_box')
        forgotcheck.Bind(wx.EVT_CHECKBOX, self.on_forgotcheck)

        firstcheck=wx.CheckBox(self, label="FIRST entry since last bleeding/pain? (all days from last entry will be marked pain/bloodfree unless FORGOTTEN is also checked)",
            name='firstday_check_box')
        firstcheck.Bind(wx.EVT_CHECKBOX, self.on_firstdaycheck)

        bloodbox=wx.RadioBox(self, label="bleeding amount (0-no blood, 1-spotting, 2 - light bleeding, 3- medium bleeding, 4- stronger bleeding, 5- heavy bleeding)",
            choices=['0','1','2','3','4','5'], majorDimension=0, style=wx.RA_SPECIFY_COLS,
            name='blood_radio_box')
        bloodbox.Bind(wx.EVT_RADIOBOX, self.on_bloodbox)
        painbox=wx.RadioBox(self, label="pain amount (Mankoski Pain Scale - http://www.valis.com/andi/painscale.html)",
            choices=['0','1','2','3','4','5','6','7','8','9','10'], majorDimension=0, style=wx.RA_SPECIFY_COLS,
            name='pain_radio_box')
        painbox.Bind(wx.EVT_RADIOBOX, self.on_painbox)

        painkillercheck=wx.CheckBox(self, label="took painkiller?",
            name='painkiller_check_box')
        painkillercheck.Bind(wx.EVT_CHECKBOX, self.on_painkillercheck)

        conf_button = wx.Button(self, label='Confirm')
        conf_button.Bind(wx.EVT_BUTTON, self.on_conf)

        vis_button = wx.Button(self, label='Visualize')
        vis_button.Bind(wx.EVT_BUTTON, self.on_vis)

        
        main_sizer = wx.BoxSizer(wx.VERTICAL)
        
        main_sizer.Add(self.dateselector, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(forgotcheck, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(firstcheck, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(bloodbox, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(painbox, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(painkillercheck, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(conf_button, proportion=1,
                       flag=wx.ALL | wx.CENTER | wx.EXPAND,
                       border=5)
        main_sizer.Add(vis_button, proportion=1,
                       flag=wx.ALL | wx.LEFT | wx.SHAPED,
                       border=5)
        self.SetSizer(main_sizer)


    


    def on_selectionchanged(self, event):
        date=event.PyGetDate()
        self.day=date.day
        self.month=date.month
        self.year=date.year
    
    def on_pagechanged(self, event):
        # self.markdays(self.dateselector, self.markstyle)
        print()
        
        
            

    def on_forgotcheck(self, event):
        self.forgotcheck=event.IsChecked() 
         
    

    def on_firstdaycheck(self, event):
        self.firstday=event.IsChecked()

    def on_bloodbox(self, event):
        self.blood = event.GetSelection()
    
    def on_painbox(self, event):
        self.pain=event.GetSelection()

    def on_painkillercheck(self, event):
        self.painkiller=event.IsChecked()

    def on_conf(self, event):
        if self.forgotcheck == True:
            filehandling.fillpast(savefile, self.year, self.month, self.day, 'forgotten')
        elif self.firstday == True:
            filehandling.fillpast(savefile, self.year, self.month, self.day, 'zeros')
        entryexists=filehandling.checkentryexists(savefile, self.year, self.month, self.day)
        if entryexists[0]:
            popper=wx.MessageDialog(None, 'An entry for this date already exists. Do you want to overwrite it?', 'Warning', wx.YES_NO).ShowModal()
        else:
            popper= None

        if popper == wx.ID_NO:
            return
        if popper == wx.ID_YES:
            filehandling.deleteentry(savefile,entryexists[1])
            
        print('creating entry')
        filehandling.createentry(savefile, self.year, self.month, self.day, self.firstday,self.blood, self.pain, self.painkiller, self.forgotcheck)
        filehandling.orderbydate(savefile)
        exit()    

    def on_vis(self, event):
        visualization.visualize(savefiles)
        
class MyFrame(wx.Frame):
    
    def __init__(self):
        super().__init__(None, title='Red Calendar', size=(400, 500))
        panel = MyPanel(self)
        
        self.Show()


if __name__ == '__main__':
    filehandling.checkcreatesavefile(savefile)
    app = wx.App(redirect=False)
    frame = MyFrame()
    app.MainLoop()

def startapp():
    app = wx.App(redirect=False)
    frame = MyFrame()
    app.MainLoop()

def restartapp():
    self.Destroy()
    